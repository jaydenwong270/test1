<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flappy Bird - åƒç´ å¾©å¤ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Courier New', Courier, monospace; /* æ”¹ç”¨å¾©å¤ç­‰å¯¬å­—é«” */
        }
        
        body {
            background-color: #1a1a2e; /* æ›´æ·±çš„èƒŒæ™¯è‰² */
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            color: #ecf0f1;
        }

        /* --- ä¸»ä½ˆå±€å®¹å™¨ --- */
        .main-layout {
            display: flex;
            gap: 30px;
            max-width: 960px;
            width: 100%;
            background-color: #2c2c54;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.5);
            border: 4px solid #000; /* å¾©å¤é»‘æ¡† */
        }

        /* å·¦å´ï¼šéŠæˆ²å€ */
        .game-section {
            flex: 0 0 auto; /* ä¸è‡ªå‹•ç¸®æ”¾ */
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* å³å´ï¼šæ§åˆ¶é¢æ¿ */
        .panel-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        header {
            text-align: center;
            margin-bottom: 20px;
            width: 100%;
        }
        
        h1 {
            color: #f1c40f;
            font-size: 3.5rem;
            margin-bottom: 5px;
            /* åƒç´ é¢¨æ–‡å­—é™°å½± */
            text-shadow: 4px 4px 0 #c0392b, 8px 8px 0 #000;
            letter-spacing: 2px;
            text-transform: uppercase;
        }
        
        .subtitle {
            color: #ecf0f1;
            font-size: 1.2rem;
            margin-bottom: 10px;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
        }
        
        .game-container {
            position: relative;
            /* è¨­å®šç‚º 4:3 çš„å¯¬åº¦ (480px) */
            width: 480px; 
            border: 4px solid #000;
            overflow: hidden;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
            background-color: #000;
        }
        
        /* é—œéµä¿®æ”¹ï¼šè®“ Canvas å‘ˆç¾åƒç´ åŒ– */
        #gameCanvas {
            background-color: #4ec0ca; /* ç¶“å…¸å¤©ç©ºè— */
            display: block;
            position: relative; 
            z-index: 0;
            image-rendering: pixelated; /* ç¢ºä¿åƒç´ æ¸…æ™°ä¸æ¨¡ç³Š */
            image-rendering: crisp-edges;
        }
        
        .score-container {
            position: absolute;
            top: 30px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            z-index: 10;
            pointer-events: none;
        }
        
        .score-box {
            /* åƒç´ é¢¨è¨ˆåˆ†æ¿ */
            background-color: rgba(0, 0, 0, 0.7);
            border: 3px solid #fff;
            color: white;
            padding: 10px 30px;
            font-size: 4rem;
            font-weight: 800;
            text-align: center;
            text-shadow: 3px 3px 0 #000;
        }
        
        /* --- çš‡å† æœ€é«˜åˆ† (å³ä¸Šè§’) --- */
        .high-score-box {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10;
        }
        
        .high-score {
            background-color: rgba(0, 0, 0, 0.8);
            border: 2px solid #f1c40f;
            color: #f1c40f;
            padding: 8px 15px;
            font-size: 1.1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 3px 3px 0 rgba(0,0,0,0.5);
        }

        /* --- å³å´é¢æ¿æ¨£å¼ --- */
        .panel-box {
            background-color: #34345a;
            border: 3px solid #000;
            padding: 20px;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
        }
        
        .panel-title {
            color: #f1c40f;
            font-size: 1.3rem;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            text-shadow: 2px 2px 0 #000;
            text-transform: uppercase;
        }
        
        .controls {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
        }
        
        .control-item {
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #2c2c54;
            padding: 10px;
            border: 2px solid #000;
        }
        
        .key {
            background-color: #f1c40f;
            color: #000;
            padding: 5px 10px;
            font-weight: bold;
            min-width: 60px;
            text-align: center;
            font-size: 0.9rem;
            box-shadow: 3px 3px 0 #000;
            border: 2px solid #000;
        }
        
        .control-desc {
            color: #ecf0f1;
            font-size: 0.95rem;
            font-weight: bold;
            text-transform: uppercase;
        }
        
        .game-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: auto; /* æ¨åˆ°åº•éƒ¨ */
        }
        
        button {
            background-color: #f1c40f;
            color: #000;
            border: 3px solid #000;
            padding: 15px 20px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.1s ease;
            font-weight: bold;
            letter-spacing: 1px;
            box-shadow: 5px 5px 0 #000;
            width: 100%;
            text-transform: uppercase;
        }
        
        button:hover {
            background-color: #f39c12;
            transform: translate(2px, 2px);
            box-shadow: 3px 3px 0 #000;
        }
        
        button:active {
            transform: translate(5px, 5px);
            box-shadow: 0px 0px 0 #000;
        }
        
        button#startBtn { background-color: #2ecc71; }
        button#startBtn:hover { background-color: #27ae60; }
        
        button#pauseBtn { background-color: #f1c40f; }
        
        button#resetBtn { background-color: #e74c3c; }
        button#resetBtn:hover { background-color: #c0392b; }
        
        .game-status {
            text-align: center;
            font-size: 1.1rem;
            font-weight: bold;
            color: #f1c40f;
            min-height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-shadow: 2px 2px 0 #000;
        }
        
        /* Game Over ç•«é¢æ¨£å¼ */
        .game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            display: none; 
        }

        .game-over-box {
            background-color: #2c3e50; /* æ·±è—åº• */
            border: 4px solid #000;
            padding: 25px;
            text-align: center;
            box-shadow: 10px 10px 0 #000;
            width: 85%;
        }

        .game-over-box h2 {
            color: #e74c3c;
            font-size: 2.5rem;
            margin-bottom: 20px;
            text-shadow: 3px 3px 0 #000;
            text-transform: uppercase;
        }

        .score-result {
            background-color: #34495e;
            padding: 15px;
            margin-bottom: 20px;
            border: 3px solid #000;
            box-shadow: inset 3px 3px 0 rgba(0,0,0,0.5);
        }

        .score-result div {
            font-size: 1.2rem;
            color: #fff;
            margin: 10px 0;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
        }

        .score-result span { color: #f1c40f; font-size: 1.5rem; text-shadow: 2px 2px 0 #000; }

        @media (max-width: 900px) {
            .main-layout {
                flex-direction: column;
                align-items: center;
                padding: 15px;
                gap: 20px;
            }
            .game-section, .panel-section {
                flex: auto;
                width: 100%;
                max-width: 480px; /* é™åˆ¶æœ€å¤§å¯¬åº¦ */
            }
            .game-container {
                width: 100%; /* æ‰‹æ©Ÿä¸Šå¯¬åº¦é©æ‡‰ */
                height: auto;
                aspect-ratio: 3/4; /* ä¿æŒæ¯”ä¾‹ */
            }
            #gameCanvas {
                width: 100%;
                height: 100%;
            }
            h1 { font-size: 2.5rem; }
        }

    </style>
</head>
<body>
    <header>
        <h1>Flappy Bird</h1>
        <div class="subtitle">PIXEL RETRO EDITION</div>
    </header>

    <div class="main-layout">
        
        <section class="game-section">
            <div class="game-container">
                <canvas id="gameCanvas" width="480" height="640"></canvas>
                
                <div class="score-container">
                    <div class="score-box" id="scoreBox">0</div>
                </div>
                
                <div class="high-score-box">
                    <div class="high-score" id="highScoreBox">ğŸ‘‘ 0</div>
                </div>

                <div id="gameOverScreen" class="game-over-screen">
                    <div class="game-over-box">
                        <h2>Game Over</h2>
                        <div class="score-result">
                            <div>SCORE <span id="finalScore">0</span></div>
                            <div>BEST <span id="finalHighScore">0</span></div>
                        </div>
                        <button id="overlayRestartBtn">TRY AGAIN</button>
                    </div>
                </div>
            </div>
        </section>

        <section class="panel-section">
            
            <div class="panel-box">
                <div class="panel-title">STATUS</div>
                <div class="game-status" id="gameStatus">PRESS SPACE OR TAP TO START</div>
            </div>

            <div class="panel-box">
                <div class="panel-title">CONTROLS</div>
                <div class="controls">
                    <div class="control-item">
                        <div class="key">SPACE</div>
                        <div class="control-desc">FLAP / START</div>
                    </div>
                    <div class="control-item">
                        <div class="key">TAP</div>
                        <div class="control-desc">SCREEN TO FLAP</div>
                    </div>
                    <div class="control-item">
                        <div class="key">P</div>
                        <div class="control-desc">PAUSE</div>
                    </div>
                    <div class="control-item">
                        <div class="key">R</div>
                        <div class="control-desc">RESET</div>
                    </div>
                </div>
            </div>

            <div class="game-controls">
                <button id="startBtn">START GAME</button>
                <button id="pauseBtn">PAUSE</button>
                <button id="resetBtn">RESET GAME</button>
            </div>

        </section>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // é—œé–‰å¹³æ»‘è™•ç†ï¼Œç¢ºä¿åƒç´ éŠ³åˆ©
        ctx.imageSmoothingEnabled = false;

        let gameRunning = false;
        let gamePaused = false;
        let score = 0;
        let highScore = 0;
        let frames = 0;
        let gameSpeed = 3; 

        const gameOverScreen = document.getElementById('gameOverScreen');
        const finalScoreEl = document.getElementById('finalScore');
        const finalHighScoreEl = document.getElementById('finalHighScore');
        const overlayRestartBtn = document.getElementById('overlayRestartBtn');
        const gameStatusElement = document.getElementById('gameStatus');
        const startBtn = document.getElementById('startBtn');
        const pauseBtn = document.getElementById('pauseBtn');
        const resetBtn = document.getElementById('resetBtn');
        const highScoreBox = document.getElementById('highScoreBox');

        function loadHighScore() {
            const savedHighScore = localStorage.getItem('flappyBirdHighScorePixel');
            if (savedHighScore) {
                highScore = parseInt(savedHighScore);
                highScoreBox.textContent = `ğŸ‘‘ ${highScore}`;
            }
        }
        
        function saveHighScore() {
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('flappyBirdHighScorePixel', highScore);
                highScoreBox.textContent = `ğŸ‘‘ ${highScore}`;
            }
        }
        
        // è¼”åŠ©å‡½æ•¸ï¼šç¹ªè£½å¸¶æœ‰é»‘é‚Šçš„çŸ©å½¢
        function drawPixelRect(x, y, w, h, fill, border = '#000', borderThickness = 3) {
            ctx.fillStyle = border;
            ctx.fillRect(x, y, w, h);
            ctx.fillStyle = fill;
            ctx.fillRect(x + borderThickness, y + borderThickness, w - borderThickness*2, h - borderThickness*2);
        }

        // --- é‡æ–°è¨­è¨ˆçš„éŠæˆ²ç‰©ä»¶ ---

        // 1. åœ°é¢èˆ‡è£é£¾
        const ground = {
            height: 112,
            groundColor: '#dba463', // æ³¥åœŸè‰²
            grassColor: '#5ee26d',  // è‰åœ°è‰²
            darkGrassColor: '#3dbd4c',
            dirtAccent1: '#c49051',
            dirtAccent2: '#a87a42',
            offset: 0, // ç”¨æ–¼æ»¾å‹•å‹•ç•«
            
            decorations: [],

            init() {
                // éš¨æ©Ÿç”Ÿæˆåœ°é¢è£é£¾ (è˜‘è‡ã€èŠ±æœµ)
                for (let i = 0; i < canvas.width; i += 60) {
                    if (Math.random() > 0.5) {
                        this.decorations.push({
                            x: i + Math.random() * 40,
                            y: canvas.height - this.height + 5,
                            type: Math.random() > 0.7 ? 'mushroom' : 'flower'
                        });
                    }
                }
            },

            draw: function() {
                let gTop = canvas.height - this.height;

                // æ³¥åœŸå±¤
                ctx.fillStyle = this.groundColor;
                ctx.fillRect(0, gTop, canvas.width, this.height);
                
                // æ³¥åœŸç´‹ç† (åƒç´ é»)
                let pixelSize = 4;
                for (let i = 0; i < canvas.width; i += pixelSize * 2) {
                    for (let j = gTop + 20; j < canvas.height; j += pixelSize * 3) {
                        ctx.fillStyle = Math.random() > 0.5 ? this.dirtAccent1 : this.dirtAccent2;
                        // ç°¡å–®çš„è¦–å·®æ»¾å‹•æ•ˆæœ
                        let drawX = (i - this.offset) % canvas.width;
                        if(drawX < 0) drawX += canvas.width;
                        ctx.fillRect(drawX, j, pixelSize, pixelSize);
                    }
                }

                // è‰åœ°å±¤ (ä¸Šå±¤æ·±è‰²ï¼Œä¸‹å±¤æ·ºè‰²)
                ctx.fillStyle = this.darkGrassColor;
                ctx.fillRect(0, gTop, canvas.width, 16);
                ctx.fillStyle = this.grassColor;
                ctx.fillRect(0, gTop, canvas.width, 12);
                
                // è‰åœ°é‚Šç·£åƒç´ ç´°ç¯€ (åŠ å…¥æ»¾å‹•)
                ctx.fillStyle = '#000';
                ctx.fillRect(0, gTop, canvas.width, 3); // æœ€ä¸Šç·£é»‘ç·š
                
                ctx.fillStyle = this.darkGrassColor;
                for(let i=0; i<canvas.width + 20; i+=16){
                     let drawX = (i - this.offset) % (canvas.width + 16);
                     if(drawX < 0) drawX += (canvas.width + 16);
                     ctx.fillRect(drawX, gTop + 12, 8, 4);
                }

                // ç¹ªè£½è£é£¾ç‰© (è·Ÿéš¨åœ°é¢æ»¾å‹•)
                this.decorations.forEach(dec => {
                    let drawX = (dec.x - this.offset) % canvas.width;
                    if (drawX < 0) drawX += canvas.width;
                    if (dec.type === 'mushroom') this.drawMushroom(drawX, dec.y);
                    else this.drawFlower(drawX, dec.y);
                });
            },
            
            update() {
                this.offset += gameSpeed;
            },

            drawMushroom(x, y) {
                 // èŒæŸ„
                 ctx.fillStyle = '#ffeebb'; ctx.fillRect(x+4, y+6, 8, 10);
                 drawPixelRect(x+4, y+6, 8, 10, '#ffeebb', '#000', 2);
                 // èŒè“‹
                 drawPixelRect(x, y, 16, 8, '#e74c3c', '#000', 2);
                 ctx.fillStyle = '#fff'; ctx.fillRect(x+4, y+2, 3, 3); ctx.fillRect(x+10, y+3, 2, 2);
            },
            drawFlower(x, y) {
                 // è–
                 ctx.fillStyle = '#3dbd4c'; ctx.fillRect(x+6, y+8, 4, 8);
                 // èŠ±æœµ
                 drawPixelRect(x+2, y, 12, 12, '#fff', '#000', 2);
                 ctx.fillStyle = '#f1c40f'; ctx.fillRect(x+6, y+4, 4, 4);
            }
        };
        ground.init();

        // 2. å°é³¥ (åƒç´ é¢¨æ ¼)
        const bird = {
            x: 80, y: canvas.height / 3, width: 48, height: 36,
            gravity: 0.5, velocity: 0, jumpPower: -7.5,
            rotation: 0,
            
            draw: function() {
                ctx.save();
                ctx.translate(this.x, this.y);
                
                // è¨ˆç®—æ—‹è½‰è§’åº¦
                if (this.velocity < 0) this.rotation = -20 * Math.PI / 180; 
                else this.rotation += 2 * Math.PI / 180; // ä¸‹å¢œæ™‚æ…¢æ…¢æ—‹è½‰
                if (this.rotation > 90 * Math.PI / 180) this.rotation = 90 * Math.PI / 180;
                
                ctx.rotate(this.rotation);

                let w = this.width; let h = this.height;
                let bx = -w/2; let by = -h/2;

                // èº«é«”ä¸»é«” (æ©™è‰²)
                drawPixelRect(bx, by, w, h-8, '#f39c12', '#000', 3);
                // è‚šå­ (æ·ºé»ƒè‰²)
                drawPixelRect(bx + 4, by + h - 16, w - 16, 12, '#f1c40f', '#000', 2);
                
                // çœ¼ç› (å¤§ç™½çœ¼çƒï¼Œé»‘ç³å­”)
                drawPixelRect(bx + w - 18, by + 4, 14, 14, '#fff', '#000', 2);
                ctx.fillStyle = '#000'; ctx.fillRect(bx + w - 10, by + 8, 4, 4);
                
                // å˜´å·´ (ç´…è‰²)
                drawPixelRect(bx + w - 4, by + 16, 12, 10, '#e74c3c', '#000', 2);
                // å˜´å·´ç·šæ¢
                ctx.fillStyle = '#000'; ctx.fillRect(bx + w - 2, by + 21, 8, 2);

                // ç¿…è†€ (ç°¡å–®åƒç´ å¡Š)
                drawPixelRect(bx - 4, by + 12, 16, 12, '#fff', '#000', 2);

                ctx.restore();
            },
            jump: function() { this.velocity = this.jumpPower; this.rotation = -20 * Math.PI / 180; },
            update: function() {
                this.velocity += this.gravity; this.y += this.velocity;
                if (this.y + this.height/2 >= canvas.height - ground.height) {
                    this.y = canvas.height - ground.height - this.height/2;
                    if (gameRunning) gameOver();
                }
                if (this.y - this.height/2 <= 0) { this.y = this.height/2; this.velocity = 0; }
            },
            reset: function() { this.y = canvas.height / 3; this.velocity = 0; this.rotation = 0; }
        };
        
        // 3. æ°´ç®¡ (åƒç´ é¢¨æ ¼)
        const pipes = {
            position: [], width: 84, gap: 170, minTopPipeHeight: 80,
            pipeColor: '#2ecc71', pipeDark: '#27ae60', pipeHighlight: '#5ee26d',
            
            draw: function() {
                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    // ç¹ªè£½å–®æ ¹æ°´ç®¡çš„å‡½æ•¸
                    this.drawSinglePipe(p.x, 0, this.width, p.top, true); // ä¸Šç®¡
                    this.drawSinglePipe(p.x, p.top + this.gap, this.width, canvas.height - (p.top + this.gap) - ground.height, false); // ä¸‹ç®¡
                }
            },

            drawSinglePipe(x, y, w, h, isTop) {
                // ä¸»é«” (å¸¶é»‘é‚Š)
                drawPixelRect(x + 4, y, w - 8, h, this.pipeColor, '#000', 3);
                
                // ç®¡å£ (è¼ƒå¯¬ï¼Œå¸¶é»‘é‚Š)
                let capH = 32;
                let capY = isTop ? y + h - capH : y;
                drawPixelRect(x, capY, w, capH, this.pipeColor, '#000', 3);
                
                // ç´°ç¯€ï¼šé«˜å…‰èˆ‡é™°å½± (å¢åŠ ç«‹é«”æ„Ÿ)
                let mainY = isTop ? y : y + capH;
                let mainH = isTop ? h - capH : h - capH;

                // ä¸»é«”é«˜å…‰(å·¦) èˆ‡ é™°å½±(å³)
                ctx.fillStyle = this.pipeHighlight; ctx.fillRect(x + 8, mainY + 3, 6, mainH - 3);
                ctx.fillStyle = this.pipeDark;      ctx.fillRect(x + w - 14, mainY + 3, 6, mainH - 3);

                // ç®¡å£é«˜å…‰èˆ‡é™°å½±
                ctx.fillStyle = this.pipeHighlight; ctx.fillRect(x + 4, capY + 4, w - 8, 4);
                ctx.fillStyle = this.pipeDark;      ctx.fillRect(x + 4, capY + capH - 8, w - 8, 4);
            },
            
            update: function() {
                if (frames % 120 === 0) {
                    const availableHeight = canvas.height - ground.height;
                    const maxTopPipeHeight = availableHeight - this.gap - 80;
                    const randomTop = Math.floor(Math.random() * (maxTopPipeHeight - this.minTopPipeHeight + 1)) + this.minTopPipeHeight;
                    this.position.push({ x: canvas.width, top: randomTop, passed: false });
                }
                for (let i = 0; i < this.position.length; i++) {
                    let p = this.position[i];
                    p.x -= gameSpeed;
                    if (!p.passed && p.x + this.width < bird.x) { p.passed = true; score++; document.getElementById('scoreBox').textContent = score; }
                    
                    // ç¢°æ’æª¢æ¸¬ (ç¨å¾®ç¸®å°ä¸€é»åˆ¤å®šç¯„åœ)
                    let hitBoxMargin = 6;
                    if (
                        bird.x + bird.width/2 - hitBoxMargin > p.x && 
                        bird.x - bird.width/2 + hitBoxMargin < p.x + this.width && 
                        (bird.y - bird.height/2 + hitBoxMargin < p.top || bird.y + bird.height/2 - hitBoxMargin > p.top + this.gap)
                    ) { gameOver(); }
                    
                    if (p.x + this.width < 0) this.position.shift();
                }
            },
            reset: function() { this.position = []; }
        };
        
        // 4. èƒŒæ™¯ (åƒç´ åŸå¸‚èˆ‡é›²æœµ)
        const background = {
            cityOffset: 0, cloudOffset: 0,
            
            draw: function() {
                // 4.1 å¤©ç©ºæ¼¸å±¤ (åƒç´ åŒ–)
                let skyStep = 40;
                for(let y=0; y<canvas.height; y+=skyStep) {
                    let colorVal = Math.floor(map(y, 0, canvas.height, 100, 220));
                    ctx.fillStyle = `rgb(78, ${colorVal}, 202)`; // å¾©å¤è—è‰²èª¿
                    ctx.fillRect(0, y, canvas.width, skyStep);
                }

                // 4.2 åƒç´ é›²æœµ (é›™å±¤)
                this.cloudOffset -= 0.5; // æ…¢é€Ÿç§»å‹•
                this.drawClouds(this.cloudOffset, 100, 0.8);
                this.drawClouds(this.cloudOffset - 200, 180, 0.6);

                // 4.3 åƒç´ åŸå¸‚å‰ªå½± (é›™å±¤è¦–å·®)
                this.cityOffset -= 0.8; // é€Ÿåº¦æ¸›æ…¢ï¼Œé¿å…çœ¼èŠ±
                this.drawCityLayer(this.cityOffset, '#34495e', 150, 2); // é æ™¯
                this.drawCityLayer(this.cityOffset * 1.5, '#2c3e50', 220, 3); // è¿‘æ™¯
            },

            drawClouds(offset, yPos, scale) {
                ctx.fillStyle = '#fff';
                let baseX = offset % canvas.width;
                if (baseX > 0) baseX -= canvas.width;
                
                for(let i=0; i<2; i++) {
                    let x = baseX + i * canvas.width;
                    let s = 20 * scale;
                    // ç°¡å–®çš„åƒç´ é›²å½¢ç‹€
                    drawPixelRect(x + 50, yPos, s*4, s, '#fff', 'rgba(0,0,0,0.1)', 2);
                    drawPixelRect(x + 70, yPos - s, s*2, s, '#fff', 'rgba(0,0,0,0.1)', 2);
                    drawPixelRect(x + 200, yPos + 50, s*3, s, '#fff', 'rgba(0,0,0,0.1)', 2);
                }
            },

            drawCityLayer(offset, color, baseHeight, blockSize) {
                ctx.fillStyle = color;
                let gTop = canvas.height - ground.height;
                let baseX = offset % (canvas.width + 100);
                 if (baseX > 0) baseX -= (canvas.width + 100);

                for(let i=0; i<2; i++) {
                    let startX = baseX + i * (canvas.width + 100);
                    // éš¨æ©Ÿç”Ÿæˆä¸€äº›å»ºç¯‰ç‰© (ä½¿ç”¨å›ºå®šçš„ç¨®å­æˆ–ç°¡å–®çš„å¾ªç’°ä¾†ä¿æŒä¸€è‡´æ€§ï¼Œé€™è£¡ç°¡åŒ–è™•ç†)
                    let currentX = startX;
                    // ç‚ºäº†è®“å»ºç¯‰ç‰©ä¸é–ƒçˆï¼Œæˆ‘å€‘éœ€è¦ä¸€ç¨®ç¢ºå®šæ€§çš„éš¨æ©Ÿï¼Œ
                    // é€™è£¡ç°¡å–®åœ°ç”¨ä½ç½®ä¾†æ±ºå®šé«˜åº¦
                    let seed = 0; 
                    while(currentX < startX + canvas.width + 100) {
                         seed++;
                         let w = 40 + (Math.sin(seed)*20 + 20); // å½éš¨æ©Ÿå¯¬åº¦
                         let h = baseHeight + (Math.cos(seed*1.5)*50 + 50); // å½éš¨æ©Ÿé«˜åº¦
                         
                         w = Math.floor(w / blockSize) * blockSize;
                         h = Math.floor(h / blockSize) * blockSize;
                         
                         ctx.fillStyle = color;
                         ctx.fillRect(currentX, gTop - h, w, h);
                         
                         // çª—æˆ¶
                         ctx.fillStyle = 'rgba(255,255,255,0.1)';
                         for(let wy = gTop - h + 20; wy < gTop - 20; wy += 30) {
                             for(let wx = currentX + 10; wx < currentX + w - 10; wx += 20) {
                                 if ((wx + wy) % 3 === 0) ctx.fillRect(wx, wy, 8, 12); // éš¨æ©Ÿäº®ç‡ˆ
                             }
                         }
                         currentX += w + 10;
                    }
                }
            }
        };

        // å·¥å…·å‡½æ•¸ï¼šæ˜ å°„æ•¸å€¼
        function map(value, start1, stop1, start2, stop2) {
            return start2 + (stop2 - start2) * ((value - start1) / (stop1 - start1));
        }
        
        function gameOver() {
            gameRunning = false;
            gameStatusElement.textContent = "GAME OVER";
            gameStatusElement.style.color = "#e74c3c";
            saveHighScore();
            finalScoreEl.textContent = score;
            finalHighScoreEl.textContent = highScore;
            gameOverScreen.style.display = 'flex'; 
        }
        
        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            background.draw();
            pipes.draw();
            ground.draw(); // åœ°é¢è¦†è“‹åœ¨æ°´ç®¡å’ŒèƒŒæ™¯ä¹‹ä¸Š
            bird.draw();
            // ç¹ªè£½å››å‘¨çš„ç²—é»‘æ¡†
            ctx.strokeStyle = '#000';
            ctx.lineWidth = 8;
            ctx.strokeRect(0,0,canvas.width, canvas.height);
        }
        
        function update() {
            if (!gameRunning || gamePaused) return;
            frames++;
            bird.update();
            pipes.update();
            ground.update(); // åœ°é¢ç¾åœ¨ä¹Ÿæœƒå‹•äº†
            draw();
            requestAnimationFrame(update);
        }
        
        function startGame() {
            if (gameRunning) return;
            gameOverScreen.style.display = 'none';
            score = 0; frames = 0;
            document.getElementById('scoreBox').textContent = score;
            gameStatusElement.textContent = "FLYING!";
            gameStatusElement.style.color = "#2ecc71";
            bird.reset(); pipes.reset();
            gameRunning = true; gamePaused = false;
            update();
        }
        
        function pauseGame() {
            if (!gameRunning) return;
            gamePaused = !gamePaused;
            if (gamePaused) {
                gameStatusElement.textContent = "PAUSED (PRESS P)";
                gameStatusElement.style.color = "#f1c40f";
            } else {
                gameStatusElement.textContent = "FLYING!";
                gameStatusElement.style.color = "#2ecc71";
                update();
            }
        }
        
        function resetGame() {
            gameRunning = false; gamePaused = false;
            gameOverScreen.style.display = 'none';
            score = 0;
            document.getElementById('scoreBox').textContent = score;
            gameStatusElement.textContent = "PRESS SPACE OR TAP TO START";
            gameStatusElement.style.color = "#f1c40f";
            bird.reset(); pipes.reset();
            background.cityOffset = 0; background.cloudOffset = 0; ground.offset = 0;
            draw();
        }
        
        document.addEventListener('keydown', (e) => {
            if (gameOverScreen.style.display === 'flex') {
                 if (e.key === ' ' || e.key === 'Spacebar' || e.key === 'r' || e.key === 'R' || e.key === 'Enter') {
                    resetGame(); e.preventDefault(); return;
                 }
            }
            switch (e.key) {
                case ' ': case 'Spacebar': case 'ArrowUp':
                    if (!gameRunning) startGame(); else if (!gamePaused) bird.jump();
                    e.preventDefault(); break;
                case 'p': case 'P':
                    pauseGame(); e.preventDefault(); break;
                case 'r': case 'R':
                    resetGame(); e.preventDefault(); break;
            }
        });
        
        canvas.addEventListener('click', () => {
            if (gameOverScreen.style.display === 'flex') return;
            if (!gameRunning) startGame(); else if (!gamePaused) bird.jump();
        });
        
        startBtn.addEventListener('click', startGame);
        pauseBtn.addEventListener('click', pauseGame);
        resetBtn.addEventListener('click', resetGame);
        overlayRestartBtn.addEventListener('click', resetGame);
        
        loadHighScore();
        // åˆå§‹åŒ–ç¹ªè£½ä¸€æ¬¡
        background.draw(); ground.draw(); bird.draw();
    </script>
</body>
</html>